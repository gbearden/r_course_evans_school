<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Part 4 - Adding tools to your Tidyverse toolbox</title>
    <meta charset="utf-8" />
    <meta name="author" content="Graham Bearden" />
    <meta name="date" content="2022-10-25" />
    <meta http-equiv='cache-control' content='no-cache'> 
    <meta http-equiv='expires' content='0'> 
    <meta http-equiv='pragma' content='no-cache'>
    <script src="libs/header-attrs-2.16/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/metropolis.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/metropolis-fonts.css" rel="stylesheet" />
    <link href="libs/countdown-0.4.0/countdown.css" rel="stylesheet" />
    <script src="libs/countdown-0.4.0/countdown.js"></script>
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# Part 4 - Adding tools to your Tidyverse toolbox
]
.author[
### Graham Bearden
]
.institute[
### University of Washington
]
.date[
### October 25, 2022
]

---


&lt;style type="text/css"&gt;
.small { font-size: 90% }
.smaller { font-size: 80% }
&lt;/style&gt;

# Housekeeping



- Reminder: Submit 2 “stakeholder-ready” data visualizations and your code on November 4 or before  
  - See examples [here](https://github.com/gbearden/r_course_evans_school/blob/master/plots/) on Github  
- What does "Stakeholder-ready" mean?  
  - Write a plot title
  - Label the axes 
  - Use a theme
  - Do not include `NA`s in the plot (geom or legend)  
- The error message &lt;span style="color:red"&gt;`could not find function "%&gt;%"`&lt;/span&gt; means you need to run `library(tidyverse)`  
- How do you clean up your RStudio environment?  
  - `rm()` 

---

# Housekeeping

- There are lots of amazing analytics and data science jobs...and the best ones are hard to get. Spend 30 minutes browsing people in the Evans School group on LinkedIn, find/connect with alumni who have jobs or work at places that interest you, and start networking  
- Datasets  
  - [Kaggle](https://www.kaggle.com/datasets)
  - [Data.gov](https://www.data.gov/)
  - [Washington Post](https://github.com/orgs/washingtonpost/repositories?language=&amp;q=data&amp;sort=&amp;type=)
  - [fivethirtyeight](https://data.fivethirtyeight.com/)  
  - [Awesome Public Datasets on Github](https://github.com/awesomedata/awesome-public-datasets)
  - [BuzzFeed](https://github.com/BuzzFeedNews)  
  - [Google Dataset Search](https://datasetsearch.research.google.com/)
  - BONUS dataset: [Great British Bakeoff](https://github.com/apreshill/bakeoff)  
  
Data for the class
```r
airbnb &lt;- read_csv('https://bit.ly/3oadz2L', col_types = cols())
climate &lt;- read_csv('https://bit.ly/3kKErEb', col_types = cols())
```

---

# What we learned in the previous class

- Overview of ggplot2  
- How to aggregate data  
- Building bar plots
  - Aggregated data
  - Disaggregated data
- Customizing plots

---

# What we'll learn today  

- Build line and scatter plots  
- How to "pivot" data, turning columns into rows and rows into columns
- More ways to use logical conditions for filtering and changing variable values
- How to merge two datasets
- Creating panels of plots with facets

---

# A reminder on troubleshooting

- Run code line by line  
- Ensure the code finished running (`+`s vs. `&gt;`s in the R console)  
- Red "x" annotation beside line numbers (after saving your file)

![](./figures/red_x_example.png)

---

# Troubleshooting exercise 

.smaller[This code contains 3 mistakes. The code is supposed to create a plot of rentals by city and room type, excluding rentals without ratings with bar colors from the `calc` palette. It's possible to successfully produce the plot after correcting 2 mistakes, but the inside color of the bars will be from the default colors palette, not from the `calc` palette. Make sure you bars are colored using the palette function.]  

```r
airbnb %&gt;% 
  filter(! is.na(rating)) %&gt;% 
  select(room_type, address, price) %&gt;% 
  group_by(room, address) %&gt;% 
  summarise(price = mean(price)) %&gt;% 
  ggplot(aes(x = address, y = price, fill = room_type)) + 
  geom_bar(stat = 'identity', position = 'dodge', alpha = .8) + 
  scale_y_continuous(label = dollar) + 
  labs(
    x = NULL,
    fill = NULL,
    y = 'Cost ($)'
    title = 'Average Cost by City and Room Type'
  ) + 
  theme_minimal() + 
  scale_color_calc()
```

<div class="countdown" id="timer_e64311eb" data-update-every="1" tabindex="0" style="right:0;bottom:0;">
<div class="countdown-controls"><button class="countdown-bump-down">&minus;</button><button class="countdown-bump-up">&plus;</button></div>
<code class="countdown-time"><span class="countdown-digits minutes">05</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

---

# Troubleshooting exercise 

.smaller[This code contains 3 mistakes. The code is supposed to create a plot of rentals by city and room type, excluding rentals without ratings with bar colors from the `calc` palette. It's possible to successfully produce the plot after correcting 2 mistakes, but the inside color of the bars will be from the default colors palette, not from the `calc` palette. Make sure you bars are colored using the palette function.]  

![](figures/troubleshooting_solution.png)

---

# Troubleshooting exercise 


```r
airbnb %&gt;% 
  filter(! is.na(rating)) %&gt;% 
  select(room_type, address, price) %&gt;% 
  group_by(room_type, address) %&gt;% 
  summarise(price = mean(price)) %&gt;% 
  ggplot(aes(x = address, y = price, fill = room_type)) + 
  geom_bar(stat = 'identity', position = 'dodge', alpha = .8) + 
  scale_y_continuous(label = dollar) + 
  labs(
    x = NULL,
    fill = NULL,
    y = 'Cost ($)',
    title = 'Average Cost by City and Room Type'
  ) + 
  theme_minimal() + 
  scale_fill_calc()
```

---
class: inverse, middle, center

# Scatterplots and line plots

---

# &lt;img src="figures/line.png" style="height: 70px"/&gt;

.pull-left[
Line plot: 1 continuous variable + ordinal variable   

- Line plots are suited well to [dates](https://gbearden.github.io/r_course_evans_school/slides/part_2/#71), but may work well other ordered variables
- `color` and `linetype` are other arguments you can use when building a line plot

```r
climate %&gt;% 
  group_by(year) %&gt;%
  summarise(uncertainty = mean(uncertainty, na.rm = TRUE)) %&gt;% 
  ggplot(aes(x = year, y = uncertainty)) +
  geom_line()
```
]

.pull-right[
![](index_files/figure-html/unnamed-chunk-4-1.png)&lt;!-- --&gt;
]

---

# &lt;img src="figures/line.png" style="height: 70px"/&gt;

.pull-left[
Line plot: 1 continuous variable + ordinal variable   

- Line plots are suited well to [dates](https://gbearden.github.io/r_course_evans_school/slides/part_2/#71), but may work well other ordered variables
- `color` and `linetype` are other arguments you can use when building a line plot

```r
climate %&gt;% 
  group_by(year) %&gt;%
  summarise(uncertainty = mean(uncertainty, na.rm = TRUE)) %&gt;% 
  ggplot(aes(x = year, y = uncertainty)) +
  geom_line()
```
]

.pull-right[
How would you make the line red? 

![](index_files/figure-html/unnamed-chunk-5-1.png)&lt;!-- --&gt;
]

---

# &lt;img src="figures/scatter.png" style="height: 70px"/&gt;


.pull-left[
Scatterplots: 2 continuous variables 

- When there are a lot of overlapping data, `alpha` is useful
- `color`, `shape`, `size` are other arguments you can use when building a scatter plot

```r
climate %&gt;% 
  ggplot(
    aes(
      x = temp
      , y = uncertainty
      )
    ) + 
  geom_point(alpha = .1)
```
]

.pull-right[
![](index_files/figure-html/unnamed-chunk-6-1.png)&lt;!-- --&gt;
]

---

# &lt;img src="figures/scatter.png" style="height: 70px"/&gt;


.pull-left[
Scatterplots: 2 continuous variables 

- When there are a lot of overlapping data, `alpha` is useful
- `color`, `shape`, `size` are other arguments you can use when building a scatter plot

```r
climate %&gt;% 
  ggplot(
    aes(
      x = temp
      , y = uncertainty
      )
    ) + 
  geom_point(alpha = .1)
```
]

.pull-right[
Take a moment to create a scatterplot with `year` and `uncertainty` from `climate`
]

---

# Exercise

- With `airbnb`, create a scatterplot that plots two numeric variables  
- In addition to `x` and `y`, include another argument in `aes()`
   - For example, `size`, `shape`, `color` or `alpha`  
- Use `group_by()` and `summarise()` if you would like  
- Feel free to subset your data with `filter` or `sample_n()`

<div class="countdown" id="timer_4b505cef" data-update-every="1" tabindex="0" style="bottom:0;left:0;">
<div class="countdown-controls"><button class="countdown-bump-down">&minus;</button><button class="countdown-bump-up">&plus;</button></div>
<code class="countdown-time"><span class="countdown-digits minutes">07</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

---

# Exercise

![](index_files/figure-html/unnamed-chunk-8-1.png)&lt;!-- --&gt;

---

# Exercise

```r
airbnb %&gt;% 
  ggplot(aes(x = longitude, y = latitude, color = address)) + 
  geom_point(alpha = .6) + 
  theme_bw() + 
  labs(
    x = 'Longitude'
    , y = 'Latitude'
    , color = 'City'
    , title = 'Coordinates of Seattle-area Airbnbs'
  )
```

---

# Exercise

- With `climate`, create a line plot of mean Fahrenheit temperatures for cities in Brazil
  - Data should be for 1850 and onward ([help](https://gbearden.github.io/r_course_evans_school/slides/part_2/#44))  
  - Use the following formula to convert Celsius to Fahrenheit: `(temp * 9/5) + 32` ([help](https://gbearden.github.io/r_course_evans_school/slides/part_2/#28))  
  - Create the mean temperature with `summarise` and call it `mean_temp` ([help](https://gbearden.github.io/r_course_evans_school/slides/part_3/#33))  
  - Make line color equal to `city`
  - Feel free to change plot aesthetics as you see fit (add a theme; change axis, legend, or plot titles; change the color of lines for cities; etc.)  
  - *Click forward once for a hint on the functions required to prepare the data*  
  - *Click forward twice to see the plot you'll create*

<div class="countdown" id="timer_710b763f" data-update-every="1" tabindex="0" style="bottom:0;left:0;">
<div class="countdown-controls"><button class="countdown-bump-down">&minus;</button><button class="countdown-bump-up">&plus;</button></div>
<code class="countdown-time"><span class="countdown-digits minutes">15</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

--

```r
climate %&gt;% 
  filter() %&gt;% 
  mutate() %&gt;% 
  group_by() %&gt;% 
  summarise()
```

---

# Exercise

![](index_files/figure-html/unnamed-chunk-10-1.png)&lt;!-- --&gt;

---

# Exercise

```r
climate %&gt;% 
  filter(country == 'Brazil' &amp; year &gt;= 1850) %&gt;% 
  mutate(temp = (temp * 9/5) + 32) %&gt;% 
  group_by(year, city) %&gt;% 
  summarise(mean_temp = mean(temp, na.rm = TRUE)) %&gt;% 
  ggplot(aes(x = year, y = mean_temp, color = city)) + 
  geom_line(size = 1) + 
  theme_bw() + 
  scale_color_wsj() + 
  labs(
    x = 'Year'
    , y = 'Mean Temperature'
    , title = 'Temperatures in 6 Brazilian Cities, 1850 - present'
    , color = NULL
  )
```

---
class: inverse, middle, center

# More on writing logical conditions

---

# More on writing logical conditions

`ifelse()`  
- A logical test with a true-or-false outcome
- To make comparisons use: `==`, `&lt;`, `&lt;=`, `&gt;`, `&gt;=`, `!=`, `%in%`, `!`, `is.na()`
- Concatenate values with `c()`

--

...`ifelse()` is really powerful, but what do you do if there are more than two possible outcomes?

--

&lt;br&gt;&lt;br&gt;
...we use `case_when()`
- *n* conditions result in *n* outcomes

---

# More on writing logical conditions

`case_when()` is similar to `ifelse()` in some ways, but differences abound.

```r
airbnb %&gt;% mutate(expensive = ifelse(price &gt; 100, 'y', NA))
airbnb %&gt;% mutate(expensive = case_when(price &gt; 100 ~ 'y'))
```

--

`case_when()`
- No `FALSE` outcome exists,  always a two-sided formulae
  - left-hand side (LHS) and right-hand side (RHS)
  - Note the use of `~` above to separate LHS and RHS
- All RHS values must be the same type (or class)
  - `NA_character_`, `NA_integer_`, `NA_real_`
- Order of conditions matters if conditions are not mutually exclusive
- A default case of `TRUE ~ NA` is used for all conditions not stated

---

# More on writing logical conditions

`case_when()`
- No `FALSE` outcome exists,  always a two-sided formulae
  - left-hand side (LHS) and right-hand side (RHS)
  - Note the use of `~` above to separate LHS and RHS

```r
airbnb %&gt;% 
  mutate(
    price_cat = case_when(price &lt; 100                  ~ 'low' # first formula
                          , price &gt;= 100 &amp; price &lt; 200 ~ 'mid' # second formula
                          , price &gt;= 200               ~ 'high') # third formula
    )
```

---

# More on writing logical conditions

`case_when()`
- All RHS values must be the same type (or class)
  - `NA_character_`, `NA_integer_`, `NA_real_`, `NA`

**This will not work**
```r
airbnb %&gt;% 
  mutate(
    priv_share = case_when(room_type %in% c('Private room', 'Shared room') ~ price
                          , room_type == 'Entire home/apt' ~ NA)
    )
```

**This will work**
```r
airbnb %&gt;% 
  mutate(
    priv_share = case_when(room_type %in% c('Private room', 'Shared room') ~ price
                          , room_type == 'Entire home/apt' ~ NA_real_)
    )
```

---

# More on writing logical conditions

`case_when()`
- Order of conditions matters if conditions are not mutually exclusive
- A default case of `TRUE ~ NA` is used for all conditions not stated

```r
airbnb %&gt;% 
  head(2) %&gt;% 
  select(room_id, host_id, rating, accommodates, price) %&gt;% 
  mutate(
    category = case_when(rating == 5 ~ 'High rating'
                        , accommodates &gt;= 6 ~ 'Big!'
                        , price &gt;= 200 ~ 'Expensive')
    )
```

---

# Exercise

.pull-left[
With the `airbnb` data, create a bar plot that shows counts of three different home size categories. 
- Begin by creating a new variable called `home_size`
- `home_size` values should be `"Small"` (two bedrooms or fewer), `"Medium"` (three or four bedrooms), and `"Large"` (more than four bedrooms)
- Only show `"Entire home/apt"` rentals
- HINT: you can build this plot with aggregated or disaggregated data
  - Disaggregated is easier
- Update the bar [colors](https://coolors.co/generate), plot title, axis titles, etc. if you'd like
]

.pull-right[
![](index_files/figure-html/unnamed-chunk-11-1.png)&lt;!-- --&gt;
]

<div class="countdown" id="timer_9b6a57a1" data-update-every="1" tabindex="0" style="right:0;bottom:0;">
<div class="countdown-controls"><button class="countdown-bump-down">&minus;</button><button class="countdown-bump-up">&plus;</button></div>
<code class="countdown-time"><span class="countdown-digits minutes">10</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

---

# Exercise

```r
airbnb %&gt;% 
  mutate(
    home_size = case_when(bedrooms &lt;= 2 ~ 'Small'
                          , bedrooms %in% 3:4 ~ 'Medium'
                          , bedrooms &gt; 4 ~ 'Large')
    ) %&gt;% 
  filter(room_type == 'Entire home/apt') %&gt;% 
  ggplot(aes(x = home_size)) +
  geom_bar(fill = '#7C98B3') + 
  scale_y_continuous(labels = comma) + 
  theme_hc() + 
  labs(x = 'Home Size', y = 'Number of Homes')
```

---

# More on writing logical conditions

`ifelse()`  
- A logical test with a true-or-false outcome
- To make comparisons use: `==`, `&lt;`, `&lt;=`, `&gt;`, `&gt;=`, `!=`, `%in%`, `!`, `is.na()`
  - **Or use `str_detect()` to search for patterns over strings**

`str_detect()` has three arguments
- `string`, where you are searching for the pattern
- `pattern`, the pattern to look for
- `negate`, whether you want to return matches or non-matches 


```r
california &lt;- c('San Francisco', 'Los Angeles', 'San Diego')

ifelse(str_detect(california, 'San'), TRUE, NA)
## [1] TRUE   NA TRUE
case_when(str_detect(california, 'San') ~ TRUE)
## [1] TRUE   NA TRUE
```

---

# More on writing logical conditions

`ifelse()`  
- A logical test with a true-or-false outcome
- To make comparisons use: `==`, `&lt;`, `&lt;=`, `&gt;`, `&gt;=`, `!=`, `%in%`, `!`, `is.na()`
  - **Or use `str_detect()` to search for patterns over strings**

`str_detect()` has three arguments
- `string`, where you are searching for the pattern
- `pattern`, the pattern to look for
- `negate`, whether you want to return matches or non-matches 

```r
airbnb %&gt;% 
  transmute(
    room_id
    , reviews
    , price
    , cozy = ifelse(str_detect(name, 'cozy'), 'so cozy', 'not so cozy')
    )
```

---

# More on writing logical conditions

`str_detect()` and `tolower()` together  
- Casing becomes a problem when searching over strings
- `tolower()` solves that problem

```r
airbnb %&gt;% 
  transmute(
    room_id
    , reviews
    , price
    , urban_1 = ifelse(str_detect(name, 'urban'), 'so urban', 'not so urban')
    , urban_2 = ifelse(str_detect(tolower(name), 'urban'), 'so urban', 'not so urban')
    )
```

---

# More on writing logical conditions

Use `str_detect()` with `ifelse()`, `case_when()`, or `filter()`

```r
airbnb %&gt;% 
  filter(str_detect(name, 'Cozy'))
```

--

Use multiple conditions to subset your data with `filter()`

```r
airbnb %&gt;% 
  filter(str_detect(name, 'Cozy') &amp; str_detect(name, 'Quiet'))

airbnb %&gt;% 
  filter(str_detect(name, 'Cozy') | str_detect(name, 'Quiet'))
```

---

# Exercise

.pull-left[
Build on your code you from the previous exercise. Create a new variable that you can use to color bar segments, making your bar plot a stacked bar plot. 
- Name the new variable `home_category`
- `home_category` should include the following values: `"Lake"` (where any `name` value contains the word `"lake"`), `"Historic"` (where any `name` value contains the word `"historic"`), `"Modern"` (where any `name` value contains the word `"modern"`)  
- Remember that `case_when()` will set `home_category` to `NA` if cases for `"Lake"`, `"Historic"`, or `"Modern"` are not met
- Exclude rentals with `NA` `home_category` values from your plot. 
]

.pull-right[
![](index_files/figure-html/unnamed-chunk-14-1.png)&lt;!-- --&gt;

![](index_files/figure-html/unnamed-chunk-15-1.png)&lt;!-- --&gt;
]

<div class="countdown" id="timer_0430977e" data-update-every="1" tabindex="0" style="right:0;bottom:0;">
<div class="countdown-controls"><button class="countdown-bump-down">&minus;</button><button class="countdown-bump-up">&plus;</button></div>
<code class="countdown-time"><span class="countdown-digits minutes">10</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

---

# Exercise

```r
airbnb %&gt;% 
  mutate(
    home_size = case_when(bedrooms &lt;= 2 ~ 'Small'
                          , bedrooms %in% 3:4 ~ 'Medium'
                          , bedrooms &gt; 4 ~ 'Large')
    , home_category = case_when(str_detect(tolower(name), 'lake') ~ 'Lake'
                                , str_detect(tolower(name), 'historic') ~ 'Historic'
                                , str_detect(tolower(name), 'modern') ~ 'Modern')
  ) %&gt;% 
  filter(room_type == 'Entire home/apt' &amp; ! is.na(home_category)) %&gt;% 
  ggplot(aes(x = home_size, fill = home_category)) +
  geom_bar() + 
  theme_hc() + 
  scale_fill_hc() + 
  labs(
    x = 'Home Size'
    , y = 'Number of Homes'
    , fill = element_blank()
    ) + 
  theme(legend.position = 'top')
```

---
class: inverse, middle, center

# Pivoting data

---

# Pivoting data

- `pivot_longer()` and `pivot_wider()` are the functions we use to reshape data
- Reshape means to turn...
  - Columns into rows (with `pivot_longer()`), so the new dataset is narrower, has more rows, and fewer columns than the old dataset
  - Rows into columns (with `pivot_wider()`), so the new dataset is wider and has fewer rows than the old dataset
  
&lt;img src="http://garrettgman.github.io/images/tidy-9.png" style="height: 350px"/&gt;

---

# Pivoting data 

- `pivot_longer()` and `pivot_wider()` are the functions we use to reshape data
- Reshape means to turn...
  - Columns into rows (with `pivot_longer()`), so the new dataset is narrower, has more rows, and fewer columns than the old dataset
  - Rows into columns (with `pivot_wider()`), so the new dataset is wider and has fewer rows than the old dataset
  
&lt;img src="http://garrettgman.github.io/images/tidy-8.png" style="height: 400px"/&gt;

---

# Pivoting data 
`pivot_longer()`
- Turn columns into rows
- Often data are **easier to analyze** when stored in columns
- 4 arguments
  - `data`, Your tibble 
  - `cols`, which columns you want turn into rows
  - `names_to`, name of column for column names
  - `values_to`, name of column for values in columns
  
```r
airbnb %&gt;% 
  select(room_id, host_id, room_type, address, reviews, rating) %&gt;% 
  pivot_longer(
    cols = c(reviews, rating)
    , names_to = 'rental_characteristics'
    , values_to = 'values'
    )
  
```

---

# Pivoting data 

`pivot_wider()`
- Turn rows into columns
  - Good use of screen space
  - Data may be **easier to read** when denormalized (or are in a wider format)
  - Useful format when reporting + useful setting up calculations in specific situations
- 3 arguments
  - `data`, your tibble  
  - `names_from`, name of column that contains the names of the new columns
  - `values_from`, name of columns that contains the values of the new columns

```r
airbnb %&gt;% 
  group_by(address, room_type) %&gt;% 
  summarise(number_of_rentals = n(), .groups = 'drop') %&gt;% 
  pivot_wider(names_from = room_type, values_from = number_of_rentals)
```

--

```r
airbnb %&gt;% 
  group_by(address, room_type) %&gt;% 
  summarise(number_of_rentals = n(), .groups = 'drop') %&gt;% 
  pivot_wider(names_from = room_type, values_from = number_of_rentals) %&gt;%
  mutate(private_or_shared = `Private room` + `Shared room`)
```

---

# Pivoting data 

Complete either Exercise #1 or #2 in 10 minutes. You pick.  
See hints on next slide.

**Exercise #1**: With the `climate` data, report the mean temperatures for `"Angola"`, `"Ivory Coast"`, `"Ethiopia"`
, and `"Kenya"` in the years `1850`, `1900`, `1950`, and `2000`
- There should be one row per country
- You should pivot the data so the years are columns like in the example 
- In this exercise you will use `filter()`, `group_by()`, `summarise()`, and `pivot_wider()`

**Exercise #2**: With the `airbnb` data, create a bar plot that shows the average number of bathrooms and bedrooms by room type.
- In this exercise you will use `group_by()`, `summarise()`, and `pivot_longer()`
- To create the plot, you will have a `y` variable; therefore `stat = 'identity'`
- The `names_to` variable you create with `pivot_longer()` should be the variable you use to color the bars and the bars should be unstacked (`position = 'dodge'`)
- Update plot aesthetics as you'd like

<div class="countdown" id="timer_7f9dd3a9" data-update-every="1" tabindex="0" style="top:0;right:0;">
<div class="countdown-controls"><button class="countdown-bump-down">&minus;</button><button class="countdown-bump-up">&plus;</button></div>
<code class="countdown-time"><span class="countdown-digits minutes">10</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

---

# Pivoting data 

.pull-left[

**Exercise #1 hint**

```
##       country 1850 1900 1950 2000
## 1      Angola    -    -    -    -
## 2    Ethiopia    -    -    -    -
## 3 Ivory Coast    -    -    -    -
## 4       Kenya    -    -    -    -
```
]

.pull-right[
**Exercise #2 hint**

![](index_files/figure-html/unnamed-chunk-19-1.png)&lt;!-- --&gt;
]

---

# Pivoting data 

**Exercise #1 solution **

--

```r
climate %&gt;% 
  filter(
    country %in% c('Angola', 'Ivory Coast', 'Ethiopia', 'Kenya') 
    &amp; year %in% c(1850, 1900, 1950, 2000)
  ) %&gt;% 
  group_by(country, year) %&gt;% 
  summarise(temp = mean(temp), .groups = 'drop') %&gt;% 
  pivot_wider(names_from = year, values_from = temp, names_sort = TRUE)
```

---

# Pivoting data 

**Exercise #2 solution**

--

```r
airbnb %&gt;% 
  pivot_longer(
    cols = c(bedrooms, bathrooms)
    , names_to = 'characteristic'
    , values_to = 'count'
    ) %&gt;% 
  group_by(room_type, characteristic) %&gt;% 
  summarise(mean_count = mean(count, na.rm = TRUE), .groups = 'drop') %&gt;% 
  ggplot(aes(x = room_type, y = mean_count, fill = characteristic)) + 
  geom_bar(stat = 'identity', position = 'dodge') + 
  theme_bw() + 
  scale_fill_fivethirtyeight() + 
  labs(x = element_blank(), y = 'Average Count', fill = element_blank())
```

---
class: inverse, middle, center

# Merging tibbles

---

# Merging tibbles

- Merge tibbles with `left_join()`, `inner_join()`, `right_join()`, and `full_join()`
- Used to...
  - Merge data from multiple sources
  - Filter
- Arguments
  - `x`, left tibble
  - `y`, right tibble
  - `by`, keys used to "link" or merge tibbles

--

![](./figures/joins.jpg)
---

# Merging tibbles

- Merge tibbles with `left_join()`, `inner_join()`, `right_join()`, and `full_join()`
- Used to...
  - Merge data from multiple sources
  - Filter
- Arguments
  - `x`, left tibble
  - `y`, right tibble
  - `by`, keys used to "link" or merge tibbles

`left_join()`
- all `x` rows, matching `y` rows

```r
checkin &lt;- read_csv('https://bit.ly/3nQHlI0')

airbnb %&gt;% 
  filter(room_id %in% c(9909, 1647216, 689309)) %&gt;% 
  select(room_id, host_id, address) %&gt;% 
  left_join(checkin, by = 'room_id')
```

---

# Merging tibbles

`inner_join()`
- matching `x` rows, matching `y` rows

```r
airbnb %&gt;% 
  select(room_id, host_id, address) %&gt;% 
  inner_join(checkin, by = 'room_id') %&gt;% 
  filter(room_id %in% c(9909, 99999999))
```

`right_join()`
- matching `x` rows, all `y` rows

```r
airbnb %&gt;% 
  select(room_id, host_id, address) %&gt;% 
  right_join(
    checkin %&gt;% 
      filter(room_id %in% c(689309, 99999999))
    , by = 'room_id'
    )
```

---

# Merging tibbles

`full_join()`
- all `x` rows, all `y` rows

```r
airbnb %&gt;% 
  filter(room_id %in% c(689309, 9909)) %&gt;% 
  select(room_id, host_id, address) %&gt;% 
  full_join(
    checkin %&gt;% 
      filter(room_id %in% c(689309, 99999999))
    , by = 'room_id'
    )
```

---

# Exercise

Create a line plot that shows number of check-ins over time. There should be a line for each `address` value.
- Merge `airbnb` and `checkin`
- You can use aggregated (with `group_by()` and `summarise()`) or disaggregated data (make sure `stat = 'identity'`) to create the plot

If you build the plot without `group_by()` and `summarise()`, use `left_join()`, `inner_join()`, and `right_join()` and look at any warning messages that appear when you build the plot. What are they telling you?

<div class="countdown" id="timer_98b15791" data-update-every="1" tabindex="0" style="right:0;bottom:0;">
<div class="countdown-controls"><button class="countdown-bump-down">&minus;</button><button class="countdown-bump-up">&plus;</button></div>
<code class="countdown-time"><span class="countdown-digits minutes">07</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

&lt;img src="index_files/figure-html/unnamed-chunk-21-1.png" width="45%" /&gt;

---

# Exercise

```r
airbnb %&gt;% 
  left_join(checkin, by = 'room_id') %&gt;% 
  ggplot(aes(x = check_in_date, color = address)) + 
  geom_line(stat = 'count', size = 1) + 
  theme_bw() + 
  scale_color_few() + 
  labs(
    x = 'Check-in Date'
    , y = 'Number of Check-ins (#)'
    , color = element_blank()
  )
```

---
class: inverse, middle, center

# Using panels in data visualizations

---

# Using panels in data visualizations

- Create panels of plots with two functions from `ggplot2`: `facet_wrap()` and `facet_grid()`
  - Allows for better curation and organization
  - Useful when there is a lot of geom overlap
  - Useful when you need more variables to tell a story than what can be plotted using `aes()`

&lt;img src="index_files/figure-html/unnamed-chunk-22-1.png" width="40%" style="display: block; margin: auto;" /&gt;

---

# Using panels in data visualizations

- Create panels of plots with two functions from `ggplot2`: `facet_wrap()` and `facet_grid()`
  - Allows for better curation and organization
  - Useful when there is a lot of geom overlap
  - Useful when you need more variables to tell a story than what can be plotted using `aes()`

&lt;img src="index_files/figure-html/unnamed-chunk-23-1.png" width="40%" style="display: block; margin: auto;" /&gt;

---

# Using panels in data visualizations

When to use `facet_wrap()`
- Probably the better choice if you want to create the panel matrix from a single variable
- You want some control over axis lengths
- You want control over the number of plots on each row
  
`facet_wrap()` arguments
- `facets`, variable you use to create the panels
  - Multiple ways to call variables, using `~` is the easiest
- `nrow`, number of rows of panels
- `ncol`, number of columns of panels
- `scales`, indication of whether `x` and `y` axes should have the same lengths across panels; `"free"`, `"free_y"`, `"free_x"`

```r
airbnb %&gt;% ggplot(aes(accommodates)) + geom_bar() + facet_wrap(. ~ address)
airbnb %&gt;% ggplot(aes(accommodates)) + geom_bar() + facet_wrap(. ~ address, scales = 'free_y')
airbnb %&gt;% ggplot(aes(accommodates)) + geom_bar() + facet_wrap(. ~ address, scales = 'free')
airbnb %&gt;% ggplot(aes(accommodates)) + geom_bar() + facet_wrap(. ~ address, scales = 'free_y', nrow = 1)
```

---

# Using panels in data visualizations

When to use `facet_grid()`
- Probably the better choice if you want to create the panel matrix from two variables
  
`facet_grid()` arguments
- `facets`, variable you use to create the panels
  - Multiple ways to call variables, using `~` is the easiest
  - Two-sided formula, LHS: rows, RHS: columns

```r
airbnb %&gt;% ggplot() + facet_grid(. ~ address)
airbnb %&gt;% ggplot() + facet_grid(address ~ .)
airbnb %&gt;% ggplot() + facet_grid(address ~ room_type)
airbnb %&gt;% ggplot() + facet_grid(room_type ~ address)
```

---

# Using panels in data visualizations

**Quick practice: 1 of 2**

We created this plot in the last class. Add `facet_wrap()` to show one panel per `city`.
```r
climate %&gt;% 
  filter(country == 'Brazil' &amp; year &gt;= 1850) %&gt;% 
  mutate(temp = (temp * 9/5) + 32) %&gt;% 
  group_by(year, city) %&gt;% 
  summarise(mean_temp = mean(temp, na.rm = TRUE), .groups = 'drop') %&gt;% 
  ggplot(aes(x = year, y = mean_temp, color = city)) + 
  geom_line(size = 1) + 
  theme_bw() + 
  theme(legend.position = 'none') + 
  scale_color_wsj()
```

---

# Using panels in data visualizations

**Quick practice: 2 of 2**

We just created this plot. Add `facet_wrap()` to create 1 column of panels per `room_type`.
```r
airbnb %&gt;% 
    left_join(checkin, by = 'room_id') %&gt;% 
    ggplot(aes(x = check_in_date, color = address)) + 
    geom_line(stat = 'count', size = 1) + 
    theme_bw() + 
    scale_color_few() + 
    labs(
        x = 'Check-in Date'
        , y = 'Number of Check-ins (#)'
        , color = element_blank()
    ) 
```

---

# Exercise

With `airbnb`, create a bar plot that shows the average `price` of rentals by `address`, `room_type`, and a variable you create that flags key terms used to describe a rental in `name`.
- Call the variable you create `desc`. It should include the following values: `"Downtown"`, `"Spacious"`, `"Private"`, `"Peaceful"`, `"Beautiful"` when `name` contains them.
  - Use `case_when()`, `str_detect()`, and `tolower()`
- Exclude any rows with a `NA` value in `desc` and `"Shared room"` in `room_type`
- In addition to the functions explicitly named above, you'll use `mutate()`, `filter()`, `group_by()`, `summarise()` as well as code required for building the plot
- Use `facet_wrap()` to create a panel for each address
- Unstack bars using `position = 'dodge'`
- Remember if `stat = 'count'` or if `stat = 'identity'`

See the plot on the next slide if that helps you develop the code.  

<div class="countdown" id="timer_59da7fd8" data-update-every="1" tabindex="0" style="right:0;bottom:0;">
<div class="countdown-controls"><button class="countdown-bump-down">&minus;</button><button class="countdown-bump-up">&plus;</button></div>
<code class="countdown-time"><span class="countdown-digits minutes">12</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

---

# Exercise

&lt;img src="index_files/figure-html/unnamed-chunk-25-1.png" width="70%" style="display: block; margin: auto;" /&gt;

---

# Exercise

--

```r
airbnb %&gt;%
  mutate(desc = case_when(str_detect(tolower(name), 'downtown')    ~ 'Downtown'
                          , str_detect(tolower(name), 'spacious')  ~ 'Spacious'
                          , str_detect(tolower(name), 'private')   ~ 'Private'
                          , str_detect(tolower(name), 'peaceful')  ~ 'Peaceful'
                          , str_detect(tolower(name), 'beautiful') ~ 'Beautiful')) %&gt;% 
  filter(! is.na(desc) &amp; room_type != 'Shared room') %&gt;% 
  group_by(address, room_type, desc) %&gt;% 
  summarise(mean_price = mean(price), .groups = 'drop') %&gt;% 
  ggplot(aes(x = room_type, y = mean_price, fill = desc)) + 
  geom_bar(stat = 'identity', position = position_dodge(preserve = 'single')) + 
  facet_wrap(. ~ address) + 
  theme_bw() + 
  scale_y_continuous(labels = dollar) + 
  scale_fill_colorblind() + 
  labs(
    x       = 'Room Type'
    , y     = 'Average Price'
    , fill  = element_blank()
    , title = 'Average price by city and rental characteristic'
  )
```
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
